version: 2

env:
  - GHCR_REPO=ghcr.io/sanketsudake

project_name: fission
release:
  github:
    owner: sanketsudake
    name: fission
  prerelease: "true"
  draft: true
  header: |
    Release Highlights: https://fission.io/docs/releases/{{ .Tag }}/
    Install Guide: https://fission.io/docs/installation/
  extra_files:
    - glob: ./manifest/charts/*
    - glob: ./manifest/yamls/*

before:
  hooks:
    - go mod tidy
snapshot:
  version_template: "{{ .Tag }}"
builds:
  - &build-linux
    id: builder
    ldflags:
      - -s -w
      - -X github.com/fission/fission/pkg/info.GitCommit={{.ShortCommit}}
      - -X github.com/fission/fission/pkg/info.BuildDate={{.Date}}
      - -X github.com/fission/fission/pkg/info.Version={{.Tag}}
    gcflags:
      - all=-trimpath={{ if index .Env "GITHUB_WORKSPACE"}}{{ .Env.GITHUB_WORKSPACE }}{{ else }}{{ .Env.PWD }}{{ end }}
    asmflags:
      - all=-trimpath={{ if index .Env "GITHUB_WORKSPACE"}}{{ .Env.GITHUB_WORKSPACE }}{{ else }}{{ .Env.PWD }}{{ end }}
    env:
      - CGO_ENABLED=0
    goos:
      - linux
    goarch:
      - amd64
      - arm64
    binary: builder
    dir: ./cmd/builder
  - <<: *build-linux
    id: fetcher
    binary: fetcher
    dir: ./cmd/fetcher
  - <<: *build-linux
    id: fission-bundle
    binary: fission-bundle
    dir: ./cmd/fission-bundle
  - <<: *build-linux
    id: fission-cli
    goos:
      - linux
      - windows
      - darwin
    binary: fission
    dir: ./cmd/fission-cli
    ignore:
      - goos: windows
        goarch: arm64
  - <<: *build-linux
    id: pre-upgrade-checks
    binary: pre-upgrade-checks
    dir: ./cmd/preupgradechecks
  - <<: *build-linux
    id: reporter
    binary: reporter
    dir: ./cmd/reporter
dockers_v2:
  - id: builder
    tags:
      - latest
      - "{{ .Tag }}"
    images:
      - "{{ .Env.GHCR_REPO }}/builder"
    labels:
      org.opencontainers.image.description: "The builder assists in building the fission function source code for deployment."
      org.opencontainers.image.source: "{{.GitURL}}"
      org.opencontainers.image.created: "{{.Date}}"
      org.opencontainers.image.revision: "{{.FullCommit}}"
      org.opencontainers.image.version: "{{.Tag}}"
      org.opencontainers.image.authors: "The Fission Authors https://fission.io/"
      org.opencontainers.image.vendor: "Fission"
      org.opencontainers.image.url: "https://fission.io/"
    dockerfile: cmd/builder/Dockerfile
  - id: fetcher
    tags:
      - latest
      - "{{ .Tag }}"
    images:
      - "{{ .Env.GHCR_REPO }}/fetcher"
    labels:
      org.opencontainers.image.description: "Fetcher is a lightweight component used by environment and builder pods. Fetcher helps in fetch and upload of source/deployment packages and specializing environments."
      org.opencontainers.image.source: "{{.GitURL}}"
      org.opencontainers.image.created: "{{.Date}}"
      org.opencontainers.image.revision: "{{.FullCommit}}"
      org.opencontainers.image.version: "{{.Tag}}"
      org.opencontainers.image.authors: "The Fission Authors https://fission.io/"
      org.opencontainers.image.vendor: "Fission"
      org.opencontainers.image.url: "https://fission.io/"
    dockerfile: cmd/fetcher/Dockerfile
  - id: fission-bundle
    tags:
      - latest
      - "{{ .Tag }}"
    images:
      - "{{ .Env.GHCR_REPO }}/fission-bundle"
    labels:
      org.opencontainers.image.description: "fission-bundle is a component which is a single binary for all components. Most server side components running on server side are fission-bundle binary wrapped in container and used with different arguments."
      org.opencontainers.image.source: "{{.GitURL}}"
      org.opencontainers.image.created: "{{.Date}}"
      org.opencontainers.image.revision: "{{.FullCommit}}"
      org.opencontainers.image.version: "{{.Tag}}"
      org.opencontainers.image.authors: "The Fission Authors https://fission.io/"
      org.opencontainers.image.vendor: "Fission"
      org.opencontainers.image.url: "https://fission.io/"
    dockerfile: cmd/fission-bundle/Dockerfile
  - id: pre-upgrade-checks
    tags:
      - latest
      - "{{ .Tag }}"
    images:
      - "{{ .Env.GHCR_REPO }}/pre-upgrade-checks"
    labels:
      org.opencontainers.image.description: "Preupgradechecks ensures that Fission is ready for the targeted version upgrade by performing checks beforehand."
      org.opencontainers.image.source: "{{.GitURL}}"
      org.opencontainers.image.created: "{{.Date}}"
      org.opencontainers.image.revision: "{{.FullCommit}}"
      org.opencontainers.image.version: "{{.Tag}}"
      org.opencontainers.image.authors: "The Fission Authors https://fission.io/"
      org.opencontainers.image.vendor: "Fission"
      org.opencontainers.image.url: "https://fission.io/"
    dockerfile: cmd/preupgradechecks/Dockerfile
  - id: reporter
    tags:
      - latest
      - "{{ .Tag }}"
    images:
      - "{{ .Env.GHCR_REPO }}/reporter"
    labels:
      org.opencontainers.image.description: "The reporter gathers information that assists in improving fission."
      org.opencontainers.image.source: "{{.GitURL}}"
      org.opencontainers.image.created: "{{.Date}}"
      org.opencontainers.image.revision: "{{.FullCommit}}"
      org.opencontainers.image.version: "{{.Tag}}"
      org.opencontainers.image.authors: "The Fission Authors https://fission.io/"
      org.opencontainers.image.vendor: "Fission"
      org.opencontainers.image.url: "https://fission.io/"
    dockerfile: cmd/reporter/Dockerfile
changelog:
  disable: true
archives:
  - id: fission
    ids:
      - fission-cli
    name_template: "{{ .ProjectName }}-{{ .Tag }}-{{ .Os }}-{{ .Arch }}"
    formats:
      - binary
checksum:
  name_template: "checksums.txt"
docker_digest:
  name_template: "docker-digests.txt"

# signs the checksum file
# https://goreleaser.com/customization/sign
signs:
  - id: cosign-binary
    env:
      - COSIGN_EXPERIMENTAL=1
    signature: "${artifact}.sig.bundle"
    cmd: cosign
    artifacts: all
    args:
      - sign-blob
      - "--bundle=${signature}"
      - "${artifact}"
      - "--yes" # needed for cosign 2.0.0+

# signs our docker image
# https://goreleaser.com/customization/docker_sign
docker_signs:
  - cmd: cosign
    env:
      - COSIGN_EXPERIMENTAL=1
    artifacts: all
    args:
      - sign
      - "${artifact}"
      - "--yes" # needed for cosign 2.0.0+

sboms:
  - artifacts: archive
    id: archive
  - artifacts: source
    id: source
  - artifacts: binary
    id: binary
  - artifacts: package
    id: package
