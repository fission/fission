
name: Environments build and test 

on: 
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # Job to run change detection
  buildenv:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2    

    - name: setup go
      uses: actions/setup-go@v2

    - name: Helm installation
      uses: Azure/setup-helm@v1
      with:
        version: v3.3.4
      
    - name: Kind Clutser
      uses: engineerd/setup-kind@v0.5.0
      
    - name: Configuring and testing the Installation      
      run: |
        kubectl cluster-info --context kind-kind
        kind get kubeconfig --internal >$HOME/.kube/config
        kubectl get nodes
    
    - name: Static code analysis
      run: |
        ./hack/verify-gofmt.sh
        ./hack/verify-govet.sh
        helm lint charts/fission-all/ charts/fission-core/
    
    - name: Helm update
      run: helm repo add stable https://kubernetes-charts.storage.googleapis.com
      
    - name: Install Skaffold 
      run: |
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
        sudo install skaffold /usr/local/bin/
        skaffold version
    
    - name: Build & Install Fission
      run: |
        skaffold run -p kind
  
#     - name: Build & Install Fission CLI
#       run: |
        
  
#     - name: Integration tests
#       run: ./test/kind_test.sh
