<match fluent.**>
  type null
</match>

<source>
  type tail
  format json
  time_key time
  path /var/log/fission/*
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  tag fission.*
  read_from_head true
  refresh_interval 5
</source>

<match fission.**>
  type record_reformer
  enable_ruby true
  tag log
  <record>
    namespace ${tag_parts[4]}
    pod       ${tag_parts[5]}
    container ${tag_parts[6]}
    funcuid   ${tag_parts[7]}
  </record>
</match>

<match **>
  @type influxdb
    host  "#{ENV['INFLUXDB_ADDRESS']}"
    port  "#{ENV['INFLUXDB_PORT']}"
    dbname "#{ENV['INFLUXDB_DBNAME']}"
    user  "#{ENV['INFLUXDB_USERNAME']}"
    password  "#{ENV['INFLUXDB_PASSWD']}"
    use_ssl false
    time_precision s
    tag_keys ["funcuid", "pod"]
    sequence_tag _seq
    buffer_type memory
    buffer_chunk_limit 524288 # 512 * 1024
    buffer_queue_limit 1024
    flush_interval 5
    retry_limit 10
    retry_wait 1.0
    num_threads 2
</match>